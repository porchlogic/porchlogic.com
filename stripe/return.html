<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Order status · Porch Logic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/shop/shop.css" />
</head>

<body class="pl-body">
    <header class="pl-header">
        <div class="pl-header-left">
            <h1>Order status</h1>
            <p class="pl-tagline">Thanks for supporting Porch Logic.</p>
        </div>
        <div class="pl-header-right">
            <button class="button" type="button" onclick="window.location.href='/shop/index.html'">
                Back to shop
            </button>
        </div>
    </header>

    <main class="pl-checkout-layout">
        <section class="pl-panel">
            <h2>Checking your payment…</h2>
            <p id="status-text">Hang on while we load your order details.</p>

            <div id="status-alert" class="pl-alert pl-alert-info" style="margin-top:0.75rem;">
                <span class="pl-spinner" style="margin-right:0.4rem; vertical-align:middle;"></span>
                <span>Contacting the Porch Logic server…</span>
            </div>

            <div id="codes-section" style="display:none; margin-top:0.75rem;">
                <h3 style="font-size:0.95rem; margin-bottom:0.25rem;">Activation codes</h3>
                <ul id="codes-list" style="margin:0; padding-left:1.1rem; font-size:0.82rem;"></ul>
            </div>
        </section>
    </main>

    <footer class="pl-footer">
        <p>Porch Logic · porchlogic.com</p>
    </footer>

    <script>
        (function () {
            "use strict";

            const API_BASE = "https://api.porchlogic.com";

            function getSessionId() {
                const params = new URLSearchParams(window.location.search);
                return params.get("session_id");
            }

            async function loadStatus(sessionId) {
                const statusText = document.getElementById("status-text");
                const statusAlert = document.getElementById("status-alert");
                const codesSection = document.getElementById("codes-section");
                const codesList = document.getElementById("codes-list");

                if (!sessionId) {
                    statusText.textContent = "Missing session ID. If you just paid, check your email for a receipt.";
                    statusAlert.className = "pl-alert pl-alert-error";
                    statusAlert.textContent = "No Checkout session ID in the URL.";
                    return;
                }

                try {
                    const res = await fetch(
                        API_BASE + "/session-status?session_id=" + encodeURIComponent(sessionId)
                    );
                    if (!res.ok) {
                        throw new Error("Failed to fetch session status.");
                    }
                    const data = await res.json();
                    const status = data.status;

                    if (status === "complete") {
                        statusText.textContent = "Payment complete. Thanks for your order!";
                        statusAlert.className = "pl-alert pl-alert-info";
                        statusAlert.textContent =
                            "Check your email (" +
                            (data.customer_email || "the address you entered") +
                            ") for a receipt.";

                        const codes = data.activation_codes || [];
                        if (Array.isArray(codes) && codes.length > 0) {
                            codesSection.style.display = "block";
                            codesList.innerHTML = "";
                            codes.forEach((code) => {
                                const li = document.createElement("li");
                                li.textContent = code;
                                codesList.appendChild(li);
                            });
                        }
                    } else if (status === "open") {
                        statusText.textContent =
                            "Your payment didn’t go through yet. You can retry from the checkout page.";
                        statusAlert.className = "pl-alert pl-alert-error";
                        statusAlert.textContent = "Payment incomplete or canceled.";
                    } else {
                        statusText.textContent =
                            "Your checkout session is in status: " + status + ".";
                        statusAlert.className = "pl-alert pl-alert-info";
                        statusAlert.textContent =
                            "If something looks off, reach out via the contact info on porchlogic.com.";
                    }
                } catch (err) {
                    console.error("Error fetching session status", err);
                    statusText.textContent =
                        "Couldn’t load your order status. Check your email for a receipt or try again later.";
                    statusAlert.className = "pl-alert pl-alert-error";
                    statusAlert.textContent = err.message || "Unknown error.";
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                const sid = getSessionId();
                loadStatus(sid);
            });
        })();
    </script>
</body>

</html>